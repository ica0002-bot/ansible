#!/usr/bin/env python3

import json
import requests
import time


with open('/root/.github-api-token') as f:
    token = f.readlines()[0].strip()

# Check for invitations
url = 'https://api.github.com/user/repository_invitations?access_token=%s' % token
r = requests.get(url)
for invitation in r.json():
    url = 'https://api.github.com/user/repository_invitations/%d?access_token=%s' % (invitation['id'], token)
    r = requests.patch(url)
    print('Accepted invitation to %s' % invitation['repository']['full_name'])

# Check for repositories
repos = []

url = 'https://api.github.com/user/repos?access_token=%s' % token
r = requests.get(url)
for raw_repo in r.json():
    # Skip own repos
    if raw_repo['owner']['login'] in ['ICA0002-bot']:
        continue

    repo = {
        'name': raw_repo['name'],
        'owner_key_added': False,
        'owner_login': raw_repo['owner']['login'],
        'owner_url': raw_repo['owner']['html_url'],
        'private': raw_repo['private'],
        'pushed_at': raw_repo['pushed_at'],
        'url': raw_repo['html_url'],
    }

    # Check for user SSH keys
    key_url = '%s.keys' % raw_repo['owner']['html_url']
    r = requests.get(key_url)
    if r.text.startswith('ssh-'):
        repo['owner_key_added'] = True

    repos.append(repo)

# Compose HTML
html = '''
<html>
    <head>
        <meta http-equiv="refresh" content="30">
        <title>ICA0002 Students</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <h1>ICA0002 Students</h1>
        <table>
            <tr>
                <th>GitHub user</th>
                <th>Repository</th>
                <th>Private?</th>
                <th>SSH key added?</th>
                <th>Last activity</th>
            </tr>
'''

now = int(time.time())

for repo in repos:
    html += '<tr>'
    html += '<td><a href="%s">%s</a></td>' % (repo['owner_url'], repo['owner_login'])
    html += '<td><a href="%s">%s</a></td>' % (repo['url'], repo['name'])

    if repo['private']:
        html += '<td class="ok">Yes</td>'
    else:
        html += '<td class="fail">No</td>'

    if repo['owner_key_added']:
        html += '<td class="ok">Yes</td>'
    else:
        html += '<td class="fail">No</td>'

    last_active_time_hours = (now - int(time.mktime(time.strptime(repo['pushed_at'], '%Y-%m-%dT%H:%M:%SZ')))) / 3600
    if last_active_time_hours < 1:
        html += '<td class="ok"><abbr title="%s">less than an hour ago</abbr></td>' % repo['pushed_at']
    elif last_active_time_hours < 24:
        html += '<td class="ok"><abbr title="%s">less than a day ago</abbr></td>' % repo['pushed_at']
    elif last_active_time_hours < 24 * 7:
        html += '<td><abbr title="%s">less than a week ago</abbr></td>' % repo['pushed_at']
    elif last_active_time_hours < 24 * 14:
        html += '<td><abbr title="%s">less than two weeks ago</abbr></td>' % repo['pushed_at']
    else:
        html += '<td class="fail"><abbr title="%s">more that two weeks ago</abbr></td>' % repo['pushed_at']

    html += '</tr>'

html += '''
        </table>
        <div class="footer">Last checked on %s.</div>
    </body>
</html>
''' % time.strftime('%b %d at %H:%M %Z')

with open('/opt/ica0002/pub/students.html', 'w') as f:
    f.write(html)
